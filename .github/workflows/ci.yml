name: Multi-Platform CI Pipeline

# Triggers on push to main/dev and on pull requests
# Demonstrates: multi-platform matrix builds, staged pipeline, metrics reporting
on:
  push:
    branches: [main, dev]
  pull_request:
    branches: [main]
  workflow_dispatch:  # Allow manual trigger from GitHub UI

jobs:
  # ── Stage 1: Lint ────────────────────────────────────────────────────────
  lint:
    name: Lint (Python ${{ matrix.python-version }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false   # Run all matrix jobs even if one fails — collect full data
      matrix:
        python-version: ["3.10", "3.11", "3.12"]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install linting tools
        run: pip install flake8

      - name: Run flake8 lint check
        run: |
          flake8 src/ --max-line-length=120 --statistics
          echo "✓ Lint passed on Python ${{ matrix.python-version }}"

  # ── Stage 2: Test ────────────────────────────────────────────────────────
  test:
    name: Tests (Python ${{ matrix.python-version }})
    runs-on: ubuntu-latest
    needs: lint          # Only run if lint passes
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.10", "3.11", "3.12"]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install test dependencies
        run: pip install pytest pytest-cov

      - name: Run test suite with coverage
        run: |
          pytest tests/ -v --tb=short \
            --cov=src \
            --cov-report=term-missing \
            --cov-report=xml:coverage.xml

      - name: Upload coverage artifact
        uses: actions/upload-artifact@v4
        with:
          name: coverage-py${{ matrix.python-version }}
          path: coverage.xml

  # ── Stage 3: Build & Report ───────────────────────────────────────────────
  build-and-report:
    name: Build Artifact & Pipeline Report
    runs-on: ubuntu-latest
    needs: test          # Only run after all test matrix jobs pass

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: pip install pytest

      - name: Run full pipeline with metrics report
        run: python run_pipeline.py
        # run_pipeline.py writes a summary to $GITHUB_STEP_SUMMARY automatically

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: pipeline-artifact
          path: dist/

  # ── Stage 4: Regression Gate ──────────────────────────────────────────────
  regression-gate:
    name: Regression Gate
    runs-on: ubuntu-latest
    needs: build-and-report

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: pipeline-artifact
          path: dist/

      - name: Verify artifact integrity
        run: |
          echo "=== Artifact contents ==="
          ls -lh dist/
          python - <<'EOF'
          import zipfile, sys, os
          artifact = "dist/pipeline_utils_artifact.zip"
          if not os.path.exists(artifact):
              print("ERROR: Artifact not found")
              sys.exit(1)
          with zipfile.ZipFile(artifact) as z:
              names = z.namelist()
          print(f"Artifact contains: {names}")
          assert "pipeline_utils.py" in names, "Core module missing from artifact"
          print("✓ Artifact integrity check passed")
          EOF

      - name: Write pipeline summary
        run: |
          echo "## ✅ Pipeline Passed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Stage | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Lint (3.10, 3.11, 3.12) | ✅ Passed |" >> $GITHUB_STEP_SUMMARY
          echo "| Tests (3.10, 3.11, 3.12) | ✅ Passed |" >> $GITHUB_STEP_SUMMARY
          echo "| Build Artifact | ✅ Passed |" >> $GITHUB_STEP_SUMMARY
          echo "| Regression Gate | ✅ Passed |" >> $GITHUB_STEP_SUMMARY
